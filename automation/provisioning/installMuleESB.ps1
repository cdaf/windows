Param (
	[string]$mule_ee_version,
	[string]$InstallLicense,
	[string]$destinationInstallDir,
	[string]$sourceInstallDir,
	[string]$MMC_GROUP,
	[string]$mmcPassword,
	[string]$agentVersion,
	[string]$tomcatHomeDir,
	[string]$mmcVersion
)

# Common expression logging and error handling function, copied, not referenced to ensure atomic process
function executeExpression ($expression) {
	$error.clear()
	$exitCode = 0
	Write-Host "$expression"
	try {
		$output = Invoke-Expression $expression
	    if(!$?) { Write-Host "[$scriptName] `$? = $?"; $exitCode = 1 }
	} catch { echo $_.Exception|format-list -force; $exitCode = 2 }
    if ( $error[0] ) { Write-Host "[$scriptName] `$error[0] = $error"; $exitCode = 3 }
    if (( $LASTEXITCODE ) -and ( $LASTEXITCODE -ne 0 )) { Write-Host "[$scriptName] `$LASTEXITCODE = $LASTEXITCODE "; $exitCode = $LASTEXITCODE }
    if ( $exitCode -ne 0 ) {
    	if ( Test-Path "$muleInstallDir/logs/mule_ee.log" ) {
    		Write-Host "[$scriptName] List log file ($muleInstallDir/logs/mule_ee.log) then exit with $exitCode"
    		Get-Content $muleInstallDir/logs/mule_ee.log
    	} else {
    		Write-Host "[$scriptName] Log file ($muleInstallDir/logs/mule_ee.log) not created, exit with $exitCode"
    	}
    	exit $exitCode
    }
    return $output
}

$scriptName = 'installMuleESB.ps1'

Write-Host "`n[$scriptName] ---------- start ----------`n"

if ( $mule_ee_version ) {
	Write-Host "[$scriptName] mule_ee_version       : $mule_ee_version"
} else {
	$mule_ee_version = '3.9.3'
	Write-Host "[$scriptName] mule_ee_version       : $mule_ee_version (default)"
}

if ( $InstallLicense ) {
	Write-Host "[$scriptName] InstallLicense        : $InstallLicense"
} else {
	$InstallLicense = 'no'
	Write-Host "[$scriptName] InstallLicense        : $InstallLicense (default)"
}

if ( $destinationInstallDir ) {
	Write-Host "[$scriptName] destinationInstallDir : $destinationInstallDir"
} else {
	$destinationInstallDir = 'c:\mulesoft'
	Write-Host "[$scriptName] destinationInstallDir : $destinationInstallDir (default)"
}

if ( $sourceInstallDir) {
	Write-Host "[$scriptName] sourceInstallDir      : $sourceInstallDir"
} else {
	$sourceInstallDir = "$env:TEMP"
	Write-Host "[$scriptName] sourceInstallDir      : $sourceInstallDir (default)"
}

if ( $MMC_GROUP ) {
	Write-Host "[$scriptName] MMC_GROUP             : $MMC_GROUP"
} else {
	Write-Host "[$scriptName] MMC_GROUP not passed, MMC install will not be attempted, all subsequent arguments will be ignored."
}

if ( $mmcPassword ) {
	Write-Host "[$scriptName] mmcPassword           : ******************** "
} else {
	Write-Host "[$scriptName] mmcPassword           : not supplied"
}

if ( $agentVersion ) {
	Write-Host "[$scriptName] agentVersion          : $agentVersion"
} else {
	$agentVersion = '1.5.1'
	Write-Host "[$scriptName] agentVersion          : $agentVersion (default)"
}

if ( $tomcatHomeDir ) {
	Write-Host "[$scriptName] tomcatHomeDir         : $tomcatHomeDir"
} else {
	$tomcatHomeDir = 'C:\apache\apache-tomcat8-8.5.40'
	Write-Host "[$scriptName] tomcatHomeDir         : $tomcatHomeDir (default)"
}

if ( $mmcVersion ) {
	Write-Host "[$scriptName] mmcVersion            : $mmcVersion"
} else {
	$mmcVersion = '3.7.0'
	Write-Host "[$scriptName] mmcVersion            : $mmcVersion (default)"
}
$mmcWar="mmc-${mmcVersion}.war"

$muleDistribution = 'mule-ee-distribution-standalone' # base filename, appends to mule-ee-distribution-standalone-x.x.x.zip 
$muleServiceName = 'mule_ee'                          # the name as it will display in windows services 
$muleInstallDir = "$destinationInstallDir\mule-enterprise-standalone-" + $mule_ee_version # Extracted folder name does not match distribution file name
$muleESBEnterpriseInstall = $muleDistribution + '-' + $mule_ee_version
$muleESBEnterpriseInstallFileName = $muleESBEnterpriseInstall + '.zip'

Write-Host "[$scriptName] muleInstallDir        : $muleInstallDir"

Write-Host
$mediaVerify = @("$sourceInstallDir\$mmcWar", "$sourceInstallDir\$muleESBEnterpriseInstallFileName", "$sourceInstallDir\agent-setup-${agentVersion}.zip")
foreach ($verifyFile in $mediaVerify) { 
	if ( Test-Path "$verifyFile" ) {
		Write-Host "[$scriptName] $verifyFile found"
	} else {
		Write-Host
		Write-Host "[$scriptName] $verifyFile not found! Not action attempted"; exit 4
	}
}

Write-Host "`n[$scriptName] Extract Mule ESB"

try {
	New-Item -path $muleInstallDir -type directory -force | Out-Null
} catch {
	Write-Host "[$scriptName] Failed to create $muleInstallDir"
	throw $_
}	
Write-Host "[$scriptName] Folder installation: $muleInstallDir"

if ( Test-Path "$muleInstallDir" ) {
	Write-Host
	Write-Host "[$scriptName] Remove Existing Install"
	executeExpression "Remove-Item `"$muleInstallDir`" -Recurse"
}

Write-Host "`n[$scriptName] Unzip file contents to source install directory"
Add-Type -AssemblyName System.IO.Compression.FileSystem
executeExpression "[System.IO.Compression.ZipFile]::ExtractToDirectory(`'$sourceInstallDir\$muleESBEnterpriseInstallFileName`', `'$destinationInstallDir`')"

Write-Host "`n[$scriptName] Configure mule environment variable and add to the path"
executeExpression "[System.Environment]::SetEnvironmentVariable(`'MULE_HOME`', `'$muleInstallDir`', `'Machine`')"

$pathEnvVar=[System.Environment]::GetEnvironmentVariable("PATH","Machine")
executeExpression "[System.Environment]::SetEnvironmentVariable(`'PATH`', `'${pathEnvVar};$muleInstallDir\bin`', `'Machine`')"

Write-Host "`n[$scriptName] Configure the env var for the location of the properties files for all Mule applications"
executeExpression "[System.Environment]::SetEnvironmentVariable(`'CONFIG_FOLDER`', `'$muleInstallDir\conf`', `'Machine`')"

# Install the agent plugin, note: the subsequent copy of mule-agent.yml
if ( Test-Path "$env:temp\mule-agent" ) {
	Remove-Item "$env:temp\mule-agent" -Recurse
}
executeExpression "mkdir $env:temp\mule-agent"
executeExpression "[System.IO.Compression.ZipFile]::ExtractToDirectory(`'$sourceInstallDir\agent-setup-${agentVersion}.zip`', `'$env:temp\mule-agent`')"
executeExpression "Copy-Item `'$env:temp\mule-agent\*`' `'$muleInstallDir\bin`' -Force"

$workingDir = $(pwd) 
cd "$muleInstallDir\bin\"
executeExpression ".\amc_setup.bat -I"
executeExpression ".\amc_setup.bat -U"
cd "$workingDir"

Write-Host "`n[$scriptName] Perform Configuration ..."
Write-Host "[$scriptName]   Send configuration files to $muleInstallDir"
$workingDirectory = $(pwd)

$EncodedText = 'IwBlAG4AYwBvAGQAaQBuAGcAPQBVAFQARgAtADgADQAKACMAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ACgAjACAAUwB5AHMAdABlAG0AIABQAHIAbwBwAGUAcgB0AGkAZQBzAA0ACgAjACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgANAAoAIwAgAEwAbwBjAGEAdABpAG8AbgAgAG8AZgAgAHkAbwB1AHIAIABNAHUAbABlACAAaQBuAHMAdABhAGwAbABhAHQAaQBvAG4ALgAgACAADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADEAPQAtAEQAbQB1AGwAZQAuAGgAbwBtAGUAPQAiACUATQBVAEwARQBfAEgATwBNAEUAJQAiAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAxAC4AcwB0AHIAaQBwAHEAdQBvAHQAZQBzAD0AVABSAFUARQANAAoAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4AMgA9AC0ARABtAHUAbABlAC4AYgBhAHMAZQA9ACIAJQBNAFUATABFAF8ASABPAE0ARQAlACIADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADIALgBzAHQAcgBpAHAAcQB1AG8AdABlAHMAPQBUAFIAVQBFAA0ACgANAAoAIwAgAFMAZQB0AHMAIABJAFAAdgA0ACAAYQBkAGQAcgBlAHMAcwBlAHMAIABpAG4AIABvAHIAZABlAHIAIAB0AG8AIABhAHYAbwBpAGQAIABtAHUAbAB0AGkAYwBhAHMAdABpAG4AZwAgAGkAcwBzAHUAZQBzAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAzAD0ALQBEAGoAYQB2AGEALgBuAGUAdAAuAHAAcgBlAGYAZQByAEkAUAB2ADQAUwB0AGEAYwBrAD0AVABSAFUARQANAAoADQAKACMAIABOAGUAZQBkAGUAZAAgAHQAbwAgAGEAdgBvAGkAZAAgAGEAIABtAGUAbQBvAHIAeQAgAGwAZQBhAGsAIABvAG4AIABtAHYAZQBsACAAKABzAGUAZQAgAE0AVQBMAEUALQA3ADYANQAwACkADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADQAPQAtAEQAbQB2AGUAbAAyAC4AZABpAHMAYQBiAGwAZQAuAGoAaQB0AD0AVABSAFUARQANAAoADQAKACMAIABMAGkAbQBpAHQAIABIAFQAVABQACAAbQBvAGQAdQBsAGUAIABzAGUAbgBkACAAYQBuAGQAIAByAGUAYwBlAGkAdgBlACAAYgB1AGYAZgBlAHIAcwAgAHMAaQB6AGUAIAB0AG8AIAAxAE0AQgAgAGIAeQAgAGQAZQBmAGEAdQBsAHQAIAB0AG8AIABhAHYAbwBpAGQAIAByAHUAbgBuAGkAbgBnACAAbwB1AHQAIABvAGYAIABEAGkAcgBlAGMAdAAgAE0AZQBtAG8AcgB5AC4AIAAgAFQAbwAgAG8AcAB0AGkAbQBpAHoAZQAgAGYAbwByAA0ACgAjACAAcABlAHIAZgBvAHIAbQBhAG4AYwBlACAAdABoAGkAcwAgAHMAeQBzAHQAZQBtACAAcAByAG8AcABlAHIAdAB5ACAAcwBoAG8AdQBsAGQAIABiAGUAIAByAGUAbQBvAHYAZQBkACAAYQBuAGQAIABkAGkAcgBlAGMAdAAgAG0AZQBtAG8AcgB5ACAAaQBuAGMAcgBlAGEAcwBlAGQAIABhAHMAIAByAGUAcQB1AGkAcgBlAGQALgANAAoAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4ANQA9AC0ARABvAHIAZwAuAGcAbABhAHMAcwBmAGkAcwBoAC4AZwByAGkAegB6AGwAeQAuAG4AaQBvAC4AdAByAGEAbgBzAHAAbwByAHQALgBUAEMAUABOAEkATwBUAHIAYQBuAHMAcABvAHIAdAAuAG0AYQB4AC0AcgBlAGMAZQBpAHYAZQAtAGIAdQBmAGYAZQByAC0AcwBpAHoAZQA9ADEAMAA0ADgANQA3ADYADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADYAPQAtAEQAbwByAGcALgBnAGwAYQBzAHMAZgBpAHMAaAAuAGcAcgBpAHoAegBsAHkALgBuAGkAbwAuAHQAcgBhAG4AcwBwAG8AcgB0AC4AVABDAFAATgBJAE8AVAByAGEAbgBzAHAAbwByAHQALgBtAGEAeAAtAHMAZQBuAGQALQBiAHUAZgBmAGUAcgAtAHMAaQB6AGUAPQAxADAANAA4ADUANwA2AA0ACgANAAoAIwAgAEkAbgBjAHIAZQBhAHMAZQAgAFAAZQByAG0AYQBuAGUAbgB0ACAARwBlAG4AZQByAGEAdABpAG8AbgAgAFMAaQB6AGUAIABmAHIAbwBtACAAZABlAGYAYQB1AGwAdAAgAG8AZgAgADYANABtAA0ACgAjACAASQBuAGMAcgBlAGEAcwBlACAAdABoAGkAcwAgAHYAYQBsAHUAZQAgAGkAZgAgAHkAbwB1ACAAZwBlAHQAIAAiAEoAYQB2AGEALgBsAGEAbgBnAC4ATwB1AHQATwBmAE0AZQBtAG8AcgB5AEUAcgByAG8AcgA6ACAAUABlAHIAbQBHAGUAbgAgAHMAcABhAGMAZQAgAGUAcgByAG8AcgAiAA0ACgAjACAAVABoAGkAcwAgAHAAcgBvAHAAZQByAHQAeQAgAGkAcwAgAG4AbwB0ACAAdQBzAGUAZAAgAHcAaABlAG4AIAByAHUAbgBuAGkAbgBnACAAagBhAHYAYQAgADgAIABhAG4AZAAgAG0AYQB5ACAAYwBhAHUAcwBlACAAYQAgAHcAYQByAG4AaQBuAGcALgANAAoAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4ANwA9AC0AWABYADoAUABlAHIAbQBTAGkAegBlAD0AMgA1ADYAbQANAAoAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4AOAA9AC0AWABYADoATQBhAHgAUABlAHIAbQBTAGkAegBlAD0AMgA1ADYAbQANAAoADQAKACMAIABHAEMAIABzAGUAdAB0AGkAbgBnAHMADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADkAPQAtAFgAWAA6ACsASABlAGEAcABEAHUAbQBwAE8AbgBPAHUAdABPAGYATQBlAG0AbwByAHkARQByAHIAbwByAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAxADAAPQAtAFgAWAA6ACsAQQBsAHcAYQB5AHMAUAByAGUAVABvAHUAYwBoAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAxADEAPQAtAFgAWAA6ACsAVQBzAGUAUABhAHIATgBlAHcARwBDAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAxADIAPQAtAFgAWAA6AE4AZQB3AFMAaQB6AGUAPQA1ADEAMgBtAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAxADMAPQAtAFgAWAA6AE0AYQB4AE4AZQB3AFMAaQB6AGUAPQA1ADEAMgBtAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAxADQAPQAtAFgAWAA6AE0AYQB4AFQAZQBuAHUAcgBpAG4AZwBUAGgAcgBlAHMAaABvAGwAZAA9ADgADQAKAA0ACgAjACAAUwBlAHQAdABpAG4AZwBzAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgAxADUAPQAtAEQAbQB1AGwAZQAuAGUAbgB2AD0AJQBNAFUATABFAF8ARQBOAFYAJQANAAoAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4AMQA2AD0ALQBEAHMAZQBjAHIAZQB0AC4AawBlAHkAPQBAAE0AVQBMAEUAXwBLAEUAWQBAAA0ACgANAAoAIwAgACoAKgAqACAASQBNAFAATwBSAFQAQQBOAFQAIAAqACoAKgANAAoAIwAgAEkAZgAgAHkAbwB1ACAAZQBuAGEAYgBsAGUAIABhAG4AeQAgAG8AZgAgAHQAaABlACAAbwBwAHQAaQBvAG4AcwAgAGIAZQBsAG8AdwAsACAAeQBvAHUAIABfAG0AdQBzAHQAXwAgAGMAaABhAG4AZwBlACAAdABoAGUAIAA8AG4APgAgAHQAbwAgAGIAZQAgAGEAIAANAAoAIwAgAGMAbwBuAHMAZQBjAHUAdABpAHYAZQAgAG4AdQBtAGIAZQByACAAKABiAGEAcwBlAGQAIABvAG4AIAB0AGgAZQAgAG4AdQBtAGIAZQByACAAbwBmACAAYQBkAGQAaQB0AGkAbwBuAGEAbAAgAHAAcgBvAHAAZQByAHQAaQBlAHMAKQAgAG8AdABoAGUAcgB3AGkAcwBlACAADQAKACMAIABKAGEAdgBhACAAdwBpAGwAbAAgAG4AbwB0ACAAcABhAHIAcwBlACAAdABoAGkAcwAgAHAAcgBvAHAAZQByAHQAaQBlAHMAIABmAGkAbABlACAAYwBvAHIAcgBlAGMAdABsAHkAIQANAAoAIwAgACgAcwBlAGUAIABoAHQAdABwADoALwAvAHcAcgBhAHAAcABlAHIALgB0AGEAbgB1AGsAaQBzAG8AZgB0AHcAYQByAGUALgBvAHIAZwAvAGQAbwBjAC8AZQBuAGcAbABpAHMAaAAvAHAAcgBvAHAALQBqAGEAdgBhAC0AYQBkAGQAaQB0AGkAbwBuAGEAbAAtAG4ALgBoAHQAbQBsACkADQAKACMAIAAqACoAKgAgAEkATQBQAE8AUgBUAEEATgBUACAAKgAqACoADQAKAA0ACgAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMADQAKACMAIABIAGkAZwBoACAAQQB2AGEAaQBsAGEAYgBpAGwAaQB0AHkAIABzAGUAdAB0AGkAbgBnAHMADQAKACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABtAHUAbABlAC4AYwBsAHUAcwB0AGUAcgBJAGQAPQBEAEUARgBBAFUATABUAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgBjAGwAdQBzAHQAZQByAE4AbwBkAGUASQBkAD0AMQANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABtAHUAbABlAC4AYwBsAHUAcwB0AGUAcgBTAGkAegBlAD0AMgANAAoAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjACMAIwAjAA0ACgANAAoAIwAgAFMAdABhAGMAawAgAHQAcgBhAGMAZQBzACAAYQByAGUAIAB0AHIAdQBuAGMAYQB0AGUAZAAgAGkAbgAgAHQAaABlACAAbABvAGcAcwAgAGIAeQAgAGQAZQBmAGEAdQBsAHQADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAHYAZQByAGIAbwBzAGUALgBlAHgAYwBlAHAAdABpAG8AbgBzAD0AdAByAHUAZQANAAoADQAKACMAIABEAGUAYgB1AGcAIAByAGUAbQBvAHQAZQBsAHkALAAgAHQAaABlACAAYQBwAHAAbABpAGMAYQB0AGkAbwBuACAAdwBpAGwAbAAgAHcAYQBpAHQAIABmAG8AcgAgAHQAaABlACAAZQB4AHQAZQByAG4AYQBsACAAZABlAGIAdQBnAGcAZQByACAAdABvACAAYwBvAG4AbgBlAGMAdAAuAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBYAGQAZQBiAHUAZwANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0AWABuAG8AYQBnAGUAbgB0AA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAGoAYQB2AGEALgBjAG8AbQBwAGkAbABlAHIAPQBOAE8ATgBFAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBYAHIAdQBuAGoAZAB3AHAAOgB0AHIAYQBuAHMAcABvAHIAdAA9AGQAdABfAHMAbwBjAGsAZQB0ACwAcwBlAHIAdgBlAHIAPQB5ACwAcwB1AHMAcABlAG4AZAA9AHkALABhAGQAZAByAGUAcwBzAD0ANQAwADAANQANAAoADQAKACMAIABTAHAAZQBjAGkAZgB5ACAAYQBuACAASABUAFQAUAAgAHAAcgBvAHgAeQAgAGkAZgAgAHkAbwB1ACAAYQByAGUAIABiAGUAaABpAG4AZAAgAGEAIABmAGkAcgBlAHcAYQBsAGwALgANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABoAHQAdABwAC4AcAByAG8AeAB5AEgAbwBzAHQAPQBZAE8AVQBSAF8ASABPAFMAVAANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABoAHQAdABwAC4AcAByAG8AeAB5AFAAbwByAHQAPQBZAE8AVQBSAF8AUABPAFIAVAANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABoAHQAdABwAC4AcAByAG8AeAB5AFUAcwBlAHIAbgBhAG0AZQA9AFkATwBVAFIAXwBVAFMARQBSAF8ATgBBAE0ARQANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABoAHQAdABwAC4AcAByAG8AeAB5AFAAYQBzAHMAdwBvAHIAZAA9AFkATwBVAFIAXwBQAEEAUwBTAFcATwBSAEQADQAKAA0ACgAjACAASQBkAGUAbgB0AGkAZgBpAGMAYQB0AGkAbwBuACAAbwBmACAAeQBvAHUAcgAgAE0AdQBsAGUAIABzAGUAcgB2AGUAcgANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABtAHUAbABlAC4AcwBlAHIAdgBlAHIASQBkAD0AWQBPAFUAUgBfAE0AVQBMAEUAXwBTAEUAUgBWAEUAUgANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABtAHUAbABlAC4AYwBsAHUAcwB0AGUAcgBJAGQAPQBZAE8AVQBSAF8ATQBVAEwARQBfAEMATABVAFMAVABFAFIADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAGQAbwBtAGEAaQBuAEkAZAA9AFkATwBVAFIAXwBNAFUATABFAF8ARABPAE0AQQBJAE4ADQAKAA0ACgAjACAATQB1AGwAZQAnAHMAIAB3AG8AcgBrAGkAbgBnACAAZABpAHIAZQBjAHQAbwByAHkAIABmAG8AcgAgAFMARQBEAEEAIABxAHUAZQB1AGUAIABwAGUAcgBzAGkAcwB0AGUAbgBjAGUALAAgAHQAcgBhAG4AcwBhAGMAdABpAG8AbgBzACwAIABlAHQAYwAuAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgB3AG8AcgBrAGkAbgBnAEQAaQByAGUAYwB0AG8AcgB5AD0ALgAvAC4AbQB1AGwAZQANAAoADQAKACMAIABFAG4AYQBiAGwAZQBzACAAZgBpAHAAcwAxADQAMAAtADIAIABtAG8AZABlACwAIABkAGkAcwBhAGIAbABpAG4AZwAgAGEAbgB5ACAAYwByAHkAcAB0AG8AZwByAGEAcABoAGkAYwAgAG0AbwBkAGUAcwAgAG8AZgAgAG8AcABlAHIAYQB0AGkAbwBuACAAbgBvAHQAIABhAHAAcAByAG8AdgBlAGQAIABpAG4AIAB0AGgAZQAgAHMAdABhAG4AZABhAHIAZAAuAA0ACgAjACAATgBvAHQAZQAgAHQAaABhAHQAIABmAHUAbABsACAAYwBvAG0AcABsAGkAYQBuAGMAZQAgAGEAbABzAG8AIAByAGUAcQB1AGkAcgBlAHMAIABhACAAYwBlAHIAdABpAGYAaQBlAGQAIABKAEMARQAgAHAAcgBvAHYAaQBkAGUAcgAgAGkAbgBzAHQAYQBsAGwAZQBkAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgBzAGUAYwB1AHIAaQB0AHkALgBtAG8AZABlAGwAPQBmAGkAcABzADEANAAwAC0AMgANAAoADQAKACMAIABFAG4AYQBiAGwAZQBzAC8AZABpAHMAYQBiAGwAZQBzACAAdABoAGUAIABtAGEAcABwAGkAbgBnACAAbwBmACAAVABMAFMAIABjAG8AbgBmAGkAZwB1AHIAYQB0AGkAbwBuACAAaQBuAHQAbwAgAHMAeQBzAHQAZQBtACAAcAByAG8AcABlAHIAdABpAGUAcwANAAoAIwAgAEQAZQBmAGEAdQBsAHQAIABpAHMAIAB0AHIAdQBlACwAIABzAGUAdAAgAHQAbwAgAGYAYQBsAHMAZQAgAGYAbwByACAAYgBhAGMAawB3AGEAcgBkACAAYwBvAG0AcABhAHQAaQBiAGkAbABpAHQAeQAuAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgB0AGwAcwAuAGQAaQBzAGEAYgBsAGUAUwB5AHMAdABlAG0AUAByAG8AcABlAHIAdABpAGUAcwBNAGEAcABwAGkAbgBnAD0AdAByAHUAZQANAAoADQAKACMAIABNAGkAcwBjAGUAbABsAGEAbgBlAG8AdQBzACAAcwBlAHQAdABpAG4AZwBzAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgBlAG4AYwBvAGQAaQBuAGcAPQBVAFQARgAtADgADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAGUAbgBkAHAAbwBpAG4AdABzAC4AcwB5AG4AYwBoAHIAbwBuAG8AdQBzAD0AZgBhAGwAcwBlAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgByAGUAbQBvAHQAZQBTAHkAbgBjAD0AZgBhAGwAcwBlAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgB0AGkAbQBlAG8AdQB0AC4AcwB5AG4AYwBoAHIAbwBuAG8AdQBzAD0AMQAwADAAMAAwAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgB0AGkAbQBlAG8AdQB0AC4AdAByAGEAbgBzAGEAYwB0AGkAbwBuAD0AMwAwADAAMAAwAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgBzAHkAcwB0AGUAbQBNAG8AZABlAGwAVAB5AHAAZQA9AHMAZQBkAGEADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAGMAbABpAGUAbgB0AE0AbwBkAGUAPQBmAGEAbABzAGUADQAKAA0ACgAjACAATQBNAEMAIABBAGcAZQBuAHQAIABzAGUAdAB0AGkAbgBnAHMADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAGEAZwBlAG4AdAAuAGUAbgBhAGIAbABlAGQAPQBmAGEAbABzAGUADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAG0AbQBjAC4AYgBpAG4AZAAuAHAAbwByAHQAPQA3ADcANwA3AA0ACgANAAoAIwAgAEQAZQBiAHUAZwAgAG8AcAB0AGkAbwBuAHMADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAGQAaQBzAGEAYgBsAGUALgB0AGgAcgBlAGEAZABzAGEAZgBlAG0AZQBzAHMAYQBnAGUAcwA9AGYAYQBsAHMAZQANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0ARABtAHUAbABlAC4AbQBlAHMAcwBhAGcAZQAuAGMAYQBjAGgAZQBCAHkAdABlAHMAPQB0AHIAdQBlAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgBtAGUAcwBzAGEAZwBlAC4AYwBhAGMAaABlAE8AcgBpAGcAaQBuAGEAbAA9AHQAcgB1AGUADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAEQAbQB1AGwAZQAuAHMAdAByAGUAYQBtAGkAbgBnAC4AZQBuAGEAYgBsAGUAPQB0AHIAdQBlAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgBtAGUAcwBzAGEAZwBlAC4AYQBzAHMAZQByAHQAQQBjAGMAZQBzAHMAPQB0AHIAdQBlAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBEAG0AdQBsAGUALgB0AHIAYQBuAHMAZgBvAHIAbQAuAGEAdQB0AG8AVwByAGEAcAA9AHQAcgB1AGUADQAKAA0ACgAjACAAUABlAHIAZgBvAHIAbQBhAG4AYwBlACAAcwBlAHQAdABpAG4AZwBzAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBYAFgAOgArAFUAcwBlAEMAbwBuAGMATQBhAHIAawBTAHcAZQBlAHAARwBDAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBYAFgAOgBDAE0AUwBJAG4AaQB0AGkAYQB0AGkAbgBnAE8AYwBjAHUAcABhAG4AYwB5AEYAcgBhAGMAdABpAG8AbgA9ADYANQANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0AWABYADoAKwBVAHMAZQBDAE0AUwBJAG4AaQB0AGkAYQB0AGkAbgBnAE8AYwBjAHUAcABhAG4AYwB5AE8AbgBsAHkADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAFgAWAA6ACsAUAByAGkAbgB0AEcAQwBBAHAAcABsAGkAYwBhAHQAaQBvAG4AUwB0AG8AcABwAGUAZABUAGkAbQBlAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBYAFgAOgArAFAAcgBpAG4AdABHAEMARABlAHQAYQBpAGwAcwANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0AWABYADoAKwBQAHIAaQBuAHQARwBDAEQAYQB0AGUAUwB0AGEAbQBwAHMADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAFgAWAA6ACsAUAByAGkAbgB0AFQAZQBuAHUAcgBpAG4AZwBEAGkAcwB0AHIAaQBiAHUAdABpAG8AbgANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGEAZABkAGkAdABpAG8AbgBhAGwALgA8AG4APgA9AC0AWABsAG8AZwBnAGMAOgAlAE0AVQBMAEUAXwBIAE8ATQBFACUALwBsAG8AZwBzAC8AZwBjAC4AbABvAGcADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAFgAWAA6ACsAVQBzAGUARwBDAEwAbwBnAEYAaQBsAGUAUgBvAHQAYQB0AGkAbwBuAA0ACgAjAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYQBkAGQAaQB0AGkAbwBuAGEAbAAuADwAbgA+AD0ALQBYAFgAOgBOAHUAbQBiAGUAcgBPAGYARwBDAEwAbwBnAEYAaQBsAGUAcwA9ADUADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAFgAWAA6AEcAQwBMAG8AZwBGAGkAbABlAFMAaQB6AGUAPQAxAE0ADQAKACMAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBhAGQAZABpAHQAaQBvAG4AYQBsAC4APABuAD4APQAtAFgAWAA6AEUAcgByAG8AcgBGAGkAbABlAD0AJQBNAFUATABFAF8ASABPAE0ARQAlAC8AbABvAGcAcwAvAGUAcgByAC4AbABvAGcADQAKAA0ACgAjACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgANAAoAIwAgAFcAcgBhAHAAcABlAHIAIABQAHIAbwBwAGUAcgB0AGkAZQBzAA0ACgAjACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgANAAoAIwAgAFUAbgBjAG8AbQBtAGUAbgB0ACAAdABoAGkAcwAgAGwAaQBuAGUAIABpAG4AIAB0AGgAZQAgAGMAYQBzAGUAIABvAGYAIABzAHQAYQByAHQAdQBwACAAZgBhAGkAbAB1AHIAZQAuAA0ACgAjAHcAcgBhAHAAcABlAHIALgBkAGUAYgB1AGcAPQB0AHIAdQBlAA0ACgANAAoAIwAgAEoAYQB2AGEAIABBAHAAcABsAGkAYwBhAHQAaQBvAG4ADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYwBvAG0AbQBhAG4AZAA9ACUASgBBAFYAQQBfAEgATwBNAEUAJQAvAGIAaQBuAC8AagBhAHYAYQANAAoADQAKACMAIABKAGEAdgBhACAATQBhAGkAbgAgAGMAbABhAHMAcwANAAoAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBtAGEAaQBuAGMAbABhAHMAcwA9AG8AcgBnAC4AbQB1AGwAZQAuAG0AbwBkAHUAbABlAC4AcgBlAGIAbwBvAHQALgBNAHUAbABlAEMAbwBuAHQAYQBpAG4AZQByAEIAbwBvAHQAcwB0AHIAYQBwAA0ACgANAAoAIwAgAE0AYQBpAG4AIABjAGwAYQBzAHMAIABmAG8AcgAgAGwAZQBnAGEAYwB5ACAAbQBvAGQAZQAuACAAIABDAG8AbQBtAGUAbgB0ACAAYQBiAG8AdQB0ACAAdABoAGUAIABtAGEAaQBuAGMAbABhAHMAcwAgAHAAcgBvAHAAZQByAHQAeQAgAGEAYgBvAHYAZQAgAA0ACgAjACAAYQBuAGQAIAB1AG4AYwBvAG0AbQBlAG4AdAAgAHQAaABlACAAbwBuAGUAIABiAGUAbABvAHcALgAgACAAWQBvAHUAIAB3AGkAbABsACAAYQBsAHMAbwAgAG4AZQBlAGQAIAB0AG8AIABzAHcAaQB0AGMAaAAgAG8AdQB0ACAAdABoAGUAIAB3AHIAYQBwAHAAZQByACAADQAKACMAIABsAGkAYwBlAG4AcwBlACAAcAByAG8AcABlAHIAdABpAGUAcwAuACAAUwBlAGUAIAB0AGgAZQAgACcAdwByAGEAcABwAGUAcgAuAGwAaQBjAGUAbgBzAGUAJwAgAHAAcgBvAHAAZQByAHQAaQBlAHMAIABuAGUAYQByACAAdABoAGUAIABlAG4AZAAgAG8AZgAgAHQAaABpAHMAIAANAAoAIwAgAGYAaQBsAGUALgANAAoAIwB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAG0AYQBpAG4AYwBsAGEAcwBzAD0AbwByAGcALgBtAHUAbABlAC4AbQBvAGQAdQBsAGUALgBiAG8AbwB0AC4ATQB1AGwAZQBCAG8AbwB0AHMAdAByAGEAcAANAAoADQAKACMAIABKAGEAdgBhACAAQwBsAGEAcwBzAHAAYQB0AGgADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AYwBsAGEAcwBzAHAAYQB0AGgALgAxAD0AJQBNAFUATABFAF8ATABJAEIAJQANAAoAdwByAGEAcABwAGUAcgAuAGoAYQB2AGEALgBjAGwAYQBzAHMAcABhAHQAaAAuADIAPQAlAE0AVQBMAEUAXwBCAEEAUwBFACUALwBjAG8AbgBmAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGMAbABhAHMAcwBwAGEAdABoAC4AMwA9ACUATQBVAEwARQBfAEgATwBNAEUAJQAvAGwAaQBiAC8AYgBvAG8AdAAvACoALgBqAGEAcgANAAoADQAKACMAIABKAGEAdgBhACAATgBhAHQAaQB2AGUAIABMAGkAYgByAGEAcgB5ACAAUABhAHQAaAAgACgAbABvAGMAYQB0AGkAbwBuACAAbwBmACAALgBEAEwATAAgAG8AcgAgAC4AcwBvACAAZgBpAGwAZQBzACkADQAKAHcAcgBhAHAAcABlAHIALgBqAGEAdgBhAC4AbABpAGIAcgBhAHIAeQAuAHAAYQB0AGgALgAxAD0AJQBMAEQAXwBMAEkAQgBSAEEAUgBZAF8AUABBAFQASAAlAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGwAaQBiAHIAYQByAHkALgBwAGEAdABoAC4AMgA9ACUATQBVAEwARQBfAEgATwBNAEUAJQAvAGwAaQBiAC8AYgBvAG8AdAANAAoADQAKACMAIABJAG4AYwByAGUAYQBzAGUAIAB0AGgAZQAgAGQAZQBmAGEAdQBsAHQAIABzAHQAYQByAHQAdQBwACAAdABpAG0AZQBvAHUAdAAgAHMAbwAgAHQAaABhAHQAIAB0AGgAZQAgAEoAVgBNACAAaABhAHMAIABlAG4AbwB1AGcAaAANAAoAIwAgAHQAaQBtAGUAIAB0AG8AIABkAG8AdwBuAGwAbwBhAGQAIAB0AGgAZQAgAHIAZQBxAHUAaQByAGUAZAAgAGoAYQByAHMAIABvAG4AIABhACAAcwBsAG8AdwAgAGMAbwBuAG4AZQBjAHQAaQBvAG4ADQAKAHcAcgBhAHAAcABlAHIALgBzAHQAYQByAHQAdQBwAC4AdABpAG0AZQBvAHUAdAA9ADYAMAAwAA0ACgANAAoAIwAgAE4AdQBtAGIAZQByACAAbwBmACAAcwBlAGMAbwBuAGQAcwAgAHQAbwAgAGEAbABsAG8AdwAgAGIAZQB0AHcAZQBlAG4AIAB0AGgAZQAgAFcAcgBhAHAAcABlAHIAIABwAGkAbgBnAGkAbgBnACAAdABoAGUAIABKAFYATQAgAGEAbgBkACAAdABoAGUAIAByAGUAcwBwAG8AbgBzAGUAIABmAHIAbwBtACAAdABoAGUAIABKAFYATQANAAoAdwByAGEAcABwAGUAcgAuAHAAaQBuAGcALgB0AGkAbQBlAG8AdQB0AD0AMwAwAA0ACgANAAoAIwAgAEkAbgBpAHQAaQBhAGwAIABKAGEAdgBhACAASABlAGEAcAAgAFMAaQB6AGUAIAAoAGkAbgAgAE0AQgApAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAGkAbgBpAHQAbQBlAG0AbwByAHkAPQAxADAAMgA0AA0ACgANAAoAIwAgAE0AYQB4AGkAbQB1AG0AIABKAGEAdgBhACAASABlAGEAcAAgAFMAaQB6AGUAIAAoAGkAbgAgAE0AQgApAA0ACgB3AHIAYQBwAHAAZQByAC4AagBhAHYAYQAuAG0AYQB4AG0AZQBtAG8AcgB5AD0AMQAwADIANAANAAoADQAKACMAIABJAGcAbgBvAHIAZQAgAGcAYQBwAHMAIABpAG4AIABhAGQAZABpAHQAaQBvAG4AYQBsACAAcAByAG8AcABlAHIAdABpAGUAcwAgAHMAZQBxAHUAZQBuAGMAZQANAAoAdwByAGEAcABwAGUAcgAuAGkAZwBuAG8AcgBlAF8AcwBlAHEAdQBlAG4AYwBlAF8AZwBhAHAAcwA9AFQAUgBVAEUADQAKAA0ACgAjACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgANAAoAIwAgAFcAcgBhAHAAcABlAHIAIABMAG8AZwBnAGkAbgBnACAAUAByAG8AcABlAHIAdABpAGUAcwANAAoAIwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoADQAKACMAIABGAG8AcgBtAGEAdAAgAG8AZgAgAG8AdQB0AHAAdQB0ACAAZgBvAHIAIAB0AGgAZQAgAGMAbwBuAHMAbwBsAGUALgAgACAAKABTAGUAZQAgAGQAbwBjAHMAIABmAG8AcgAgAGYAbwByAG0AYQB0AHMAKQANAAoAdwByAGEAcABwAGUAcgAuAGMAbwBuAHMAbwBsAGUALgBmAG8AcgBtAGEAdAA9AE0ADQAKAA0ACgAjACAATABvAGcAIABMAGUAdgBlAGwAIABmAG8AcgAgAGMAbwBuAHMAbwBsAGUAIABvAHUAdABwAHUAdAAuACAAIAAoAFMAZQBlACAAZABvAGMAcwAgAGYAbwByACAAbABvAGcAIABsAGUAdgBlAGwAcwApAA0ACgB3AHIAYQBwAHAAZQByAC4AYwBvAG4AcwBvAGwAZQAuAGwAbwBnAGwAZQB2AGUAbAA9AEkATgBGAE8ADQAKAA0ACgAjACAATABvAGcAIABmAGkAbABlACAAdABvACAAdQBzAGUAIABmAG8AcgAgAHcAcgBhAHAAcABlAHIAIABvAHUAdABwAHUAdAAgAGwAbwBnAGcAaQBuAGcALgANAAoAdwByAGEAcABwAGUAcgAuAGwAbwBnAGYAaQBsAGUAPQAlAE0AVQBMAEUAXwBCAEEAUwBFACUALwBsAG8AZwBzAC8AJQBNAFUATABFAF8AQQBQAFAAJQAuAGwAbwBnAA0ACgANAAoAIwAgAEYAbwByAG0AYQB0ACAAbwBmACAAbwB1AHQAcAB1AHQAIABmAG8AcgAgAHQAaABlACAAbABvAGcAIABmAGkAbABlAC4AIAAgACgAUwBlAGUAIABkAG8AYwBzACAAZgBvAHIAIABmAG8AcgBtAGEAdABzACkADQAKAHcAcgBhAHAAcABlAHIALgBsAG8AZwBmAGkAbABlAC4AZgBvAHIAbQBhAHQAPQBNAA0ACgANAAoAIwAgAEwAbwBnACAATABlAHYAZQBsACAAZgBvAHIAIABsAG8AZwAgAGYAaQBsAGUAIABvAHUAdABwAHUAdAAuACAAIAAoAFMAZQBlACAAZABvAGMAcwAgAGYAbwByACAAbABvAGcAIABsAGUAdgBlAGwAcwApAA0ACgB3AHIAYQBwAHAAZQByAC4AbABvAGcAZgBpAGwAZQAuAGwAbwBnAGwAZQB2AGUAbAA9AEkATgBGAE8ADQAKAA0ACgAjACAATQBhAHgAaQBtAHUAbQAgAHMAaQB6AGUAIAB0AGgAYQB0ACAAdABoAGUAIABsAG8AZwAgAGYAaQBsAGUAIAB3AGkAbABsACAAYgBlACAAYQBsAGwAbwB3AGUAZAAgAHQAbwAgAGcAcgBvAHcAIAB0AG8AIABiAGUAZgBvAHIAZQANAAoAIwAgACAAdABoAGUAIABsAG8AZwAgAGkAcwAgAHIAbwBsAGwAZQBkAC4AIABTAGkAegBlACAAaQBzACAAcwBwAGUAYwBpAGYAaQBlAGQAIABpAG4AIABiAHkAdABlAHMALgAgACAAVABoAGUAIABkAGUAZgBhAHUAbAB0ACAAdgBhAGwAdQBlAA0ACgAjACAAIABvAGYAIAAwACwAIABkAGkAcwBhAGIAbABlAHMAIABsAG8AZwAgAHIAbwBsAGwAaQBuAGcALgAgACAATQBhAHkAIABhAGIAYgByAGUAdgBpAGEAdABlACAAdwBpAHQAaAAgAHQAaABlACAAJwBrACcAIAAoAGsAYgApACAAbwByAA0ACgAjACAAIAAnAG0AJwAgACgAbQBiACkAIABzAHUAZgBmAGkAeAAuACAAIABGAG8AcgAgAGUAeABhAG0AcABsAGUAOgAgADEAMABtACAAPQAgADEAMAAgAG0AZQBnAGEAYgB5AHQAZQBzAC4ADQAKAHcAcgBhAHAAcABlAHIALgBsAG8AZwBmAGkAbABlAC4AbQBhAHgAcwBpAHoAZQA9ADEAbQANAAoADQAKACMAIABNAGEAeABpAG0AdQBtACAAbgB1AG0AYgBlAHIAIABvAGYAIAByAG8AbABsAGUAZAAgAGwAbwBnACAAZgBpAGwAZQBzACAAdwBoAGkAYwBoACAAdwBpAGwAbAAgAGIAZQAgAGEAbABsAG8AdwBlAGQAIABiAGUAZgBvAHIAZQAgAG8AbABkAA0ACgAjACAAIABmAGkAbABlAHMAIABhAHIAZQAgAGQAZQBsAGUAdABlAGQALgAgACAAVABoAGUAIABkAGUAZgBhAHUAbAB0ACAAdgBhAGwAdQBlACAAbwBmACAAMAAgAGkAbQBwAGwAaQBlAHMAIABuAG8AIABsAGkAbQBpAHQALgANAAoAdwByAGEAcABwAGUAcgAuAGwAbwBnAGYAaQBsAGUALgBtAGEAeABmAGkAbABlAHMAPQAxADAADQAKAA0ACgAjACAATABvAGcAIABMAGUAdgBlAGwAIABmAG8AcgAgAHMAeQBzAC8AZQB2AGUAbgB0ACAAbABvAGcAIABvAHUAdABwAHUAdAAuACAAIAAoAFMAZQBlACAAZABvAGMAcwAgAGYAbwByACAAbABvAGcAIABsAGUAdgBlAGwAcwApAA0ACgB3AHIAYQBwAHAAZQByAC4AcwB5AHMAbABvAGcALgBsAG8AZwBsAGUAdgBlAGwAPQBOAE8ATgBFAA0ACgANAAoAIwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoADQAKACMAIABXAHIAYQBwAHAAZQByACAAVwBpAG4AZABvAHcAcwAgAFAAcgBvAHAAZQByAHQAaQBlAHMADQAKACMAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ACgAjACAAVABpAHQAbABlACAAdABvACAAdQBzAGUAIAB3AGgAZQBuACAAcgB1AG4AbgBpAG4AZwAgAGEAcwAgAGEAIABjAG8AbgBzAG8AbABlAA0ACgB3AHIAYQBwAHAAZQByAC4AYwBvAG4AcwBvAGwAZQAuAHQAaQB0AGwAZQA9ACUATQBVAEwARQBfAEEAUABQAF8ATABPAE4ARwAlAA0ACgANAAoAIwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoADQAKACMAIABXAHIAYQBwAHAAZQByACAAVwBpAG4AZABvAHcAcwAgAE4AVAAvADIAMAAwADAALwBYAFAAIABTAGUAcgB2AGkAYwBlACAAUAByAG8AcABlAHIAdABpAGUAcwANAAoAIwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoADQAKACMAIABXAEEAUgBOAEkATgBHACAALQAgAEQAbwAgAG4AbwB0ACAAbQBvAGQAaQBmAHkAIABhAG4AeQAgAG8AZgAgAHQAaABlAHMAZQAgAHAAcgBvAHAAZQByAHQAaQBlAHMAIAB3AGgAZQBuACAAYQBuACAAYQBwAHAAbABpAGMAYQB0AGkAbwBuAA0ACgAjACAAIAB1AHMAaQBuAGcAIAB0AGgAaQBzACAAYwBvAG4AZgBpAGcAdQByAGEAdABpAG8AbgAgAGYAaQBsAGUAIABoAGEAcwAgAGIAZQBlAG4AIABpAG4AcwB0AGEAbABsAGUAZAAgAGEAcwAgAGEAIABzAGUAcgB2AGkAYwBlAC4ADQAKACMAIAAgAFAAbABlAGEAcwBlACAAdQBuAGkAbgBzAHQAYQBsAGwAIAB0AGgAZQAgAHMAZQByAHYAaQBjAGUAIABiAGUAZgBvAHIAZQAgAG0AbwBkAGkAZgB5AGkAbgBnACAAdABoAGkAcwAgAHMAZQBjAHQAaQBvAG4ALgAgACAAVABoAGUADQAKACMAIAAgAHMAZQByAHYAaQBjAGUAIABjAGEAbgAgAHQAaABlAG4AIABiAGUAIAByAGUAaQBuAHMAdABhAGwAbABlAGQALgANAAoADQAKACMAIABOAGEAbQBlACAAbwBmACAAdABoAGUAIABzAGUAcgB2AGkAYwBlAA0ACgB3AHIAYQBwAHAAZQByAC4AbgB0AHMAZQByAHYAaQBjAGUALgBuAGEAbQBlAD0AJQBNAFUATABFAF8AQQBQAFAAJQANAAoADQAKACMAIABEAGkAcwBwAGwAYQB5ACAAbgBhAG0AZQAgAG8AZgAgAHQAaABlACAAcwBlAHIAdgBpAGMAZQANAAoAdwByAGEAcABwAGUAcgAuAG4AdABzAGUAcgB2AGkAYwBlAC4AZABpAHMAcABsAGEAeQBuAGEAbQBlAD0AJQBNAFUATABFAF8AQQBQAFAAXwBMAE8ATgBHACUADQAKAA0ACgAjACAARABlAHMAYwByAGkAcAB0AGkAbwBuACAAbwBmACAAdABoAGUAIABzAGUAcgB2AGkAYwBlAA0ACgB3AHIAYQBwAHAAZQByAC4AbgB0AHMAZQByAHYAaQBjAGUALgBkAGUAcwBjAHIAaQBwAHQAaQBvAG4APQAlAE0AVQBMAEUAXwBBAFAAUABfAEwATwBOAEcAJQANAAoADQAKACMAIABTAGUAcgB2AGkAYwBlACAAZABlAHAAZQBuAGQAZQBuAGMAaQBlAHMALgAgACAAQQBkAGQAIABkAGUAcABlAG4AZABlAG4AYwBpAGUAcwAgAGEAcwAgAG4AZQBlAGQAZQBkACAAcwB0AGEAcgB0AGkAbgBnACAAZgByAG8AbQAgADEADQAKAHcAcgBhAHAAcABlAHIALgBuAHQAcwBlAHIAdgBpAGMAZQAuAGQAZQBwAGUAbgBkAGUAbgBjAHkALgAxAD0ADQAKAA0ACgAjACAATQBvAGQAZQAgAGkAbgAgAHcAaABpAGMAaAAgAHQAaABlACAAcwBlAHIAdgBpAGMAZQAgAGkAcwAgAGkAbgBzAHQAYQBsAGwAZQBkAC4AIAAgAEEAVQBUAE8AXwBTAFQAQQBSAFQAIABvAHIAIABEAEUATQBBAE4ARABfAFMAVABBAFIAVAANAAoAdwByAGEAcABwAGUAcgAuAG4AdABzAGUAcgB2AGkAYwBlAC4AcwB0AGEAcgB0AHQAeQBwAGUAPQBBAFUAVABPAF8AUwBUAEEAUgBUAA0ACgANAAoAIwAgAEEAbABsAG8AdwAgAHQAaABlACAAcwBlAHIAdgBpAGMAZQAgAHQAbwAgAGkAbgB0AGUAcgBhAGMAdAAgAHcAaQB0AGgAIAB0AGgAZQAgAGQAZQBzAGsAdABvAHAALgANAAoAdwByAGEAcABwAGUAcgAuAG4AdABzAGUAcgB2AGkAYwBlAC4AaQBuAHQAZQByAGEAYwB0AGkAdgBlAD0AZgBhAGwAcwBlAA0ACgANAAoAIwAgAFMAZQB0AHMAIABhACAAcABpAGQAZgBpAGwAZQAgAHQAbwAgAHAAcgBlAHYAZQBuAHQAIABtAHUAbAB0AGkAcABsAGUAIABjAG8AcABpAGUAcwAgAG8AZgAgAHQAaABlACAAYQBwAHAAbABpAGMAYQB0AGkAbwBuACAAdABvACAAcgB1AG4AIABzAGkAbQB1AGwAdABhAG4AZQBvAHUAcwBsAHkAIABvAG4AIABXAGkAbgBkAG8AdwBzAC4AIABVAG4AYwBvAG0AbQBlAG4AdAAgAHQAaABlACAAZgBvAGwAbABvAHcAaQBuAGcAIABwAHIAbwBwAGUAcgB0AGkAZQBzACAAaQBmACAAeQBvAHUAIAB3AGkAcwBoACAAdABvACAAcwBlAHQAIAB0AGgAaQBzACAAYgBlAGgAYQB2AGkAbwB1AHIALgAgAA0ACgAjACAAVABoAGkAcwAgAGkAcwAgAHQAaABlACAAZABlAGYAYQB1AGwAdAAgAGIAZQBoAGEAdgBpAG8AdQByACAAZgBvAHIAIABVAE4ASQBYACAAYgBhAHMAZQBkACAAcwB5AHMAdABlAG0AcwAsACAAcwBvACAAbgBvACAAbgBlAGUAZAAgAHQAbwAgAHUAbgBjAG8AbQBtAGUAbgB0ACAAdABoAGUAIABwAHIAbwBwAGUAcgB0AGkAZQBzACAAaQBmACAAdABoAGkAcwAgAGkAcwAgAHQAaABlACAAYwBhAHMAZQAuAA0ACgAjACAAWQBvAHUAIABzAGgAbwB1AGwAZAAgAGIAZQAgAGEAdwBhAHIAZQAgAHQAaABhAHQALAAgAHcAaABlAG4AIAByAHUAbgBuAGkAbgBnACAAaQBuACAAVwBpAG4AZABvAHcAcwAgAHMAeQBzAHQAZQBtAHMALAAgAGkAZgAgAG0AdQBsAGUAIABpAHMAIABzAGgAdQB0AGQAbwB3AG4AIAB1AG4AZwByAGEAYwBlAGYAdQBsAGwAeQAgAHQAaABlACAAcABpAGQAZgBpAGwAZQAgAG0AYQB5ACAAcgBlAG0AYQBpAG4AIABpAG4AIABwAGwAYQBjAGUAIABwAHIAZQB2AGUAbgB0AGkAbgBnACAAZgB1AHQAdQByAGUAIABpAG4AcwB0AGEAbgBjAGUAcwAgAGYAcgBvAG0AIAByAHUAbgBuAGkAbgBnAC4AIAANAAoAIwAgAEkAZgAgAHQAaABhAHQAIABpAHMAIAB0AGgAZQAgAGMAYQBzAGUALAAgAHkAbwB1ACAAcwBvAHUAbABkACAAbQBhAG4AdQBhAGwAbAB5ACAAcgBlAG0AbwB2AGUAIAB0AGgAZQAgAHAAaQBkAGYAaQBsAGUALgANAAoAIwB3AHIAYQBwAHAAZQByAC4AcABpAGQAZgBpAGwAZQA9AC4ALwAlAE0AVQBMAEUAXwBBAFAAUAAlAC4AcABpAGQADQAKACMAdwByAGEAcABwAGUAcgAuAHAAaQBkAGYAaQBsAGUALgBzAHQAcgBpAGMAdAA9AFQAUgBVAEUADQAKAA0ACgAjACAARABvACAAbgBvAHQAIABlAGQAaQB0ACAAbABpAG4AZQBzACAAYgBlAGwAbwB3ACEADQAKAA0ACgAjACAAVABoAGkAcwAgAGkAbgBjAGwAdQBkAGUAIABzAGgAbwB1AGwAZAAgAHAAbwBpAG4AdAAgAHQAbwAgAHcAcgBhAHAAcABlAHIALQBhAGQAZABpAHQAaQBvAG4AYQBsAC4AYwBvAG4AZgAgAGYAaQBsAGUAIABpAG4AIAB0AGgAZQAgAHMAYQBtAGUAIABkAGkAcgBlAGMAdABvAHIAeQAgAGEAcwAgAHQAaABpAHMAIABmAGkAbABlAA0ACgAjACAAQQBUAFQARQBOAFQASQBPAE4AOgAgAFAAYQB0AGgAIABtAHUAcwB0ACAAYgBlACAAZQBpAHQAaABlAHIAIABhAGIAcwBvAGwAdQB0AGUAIABvAHIAIAByAGUAbABhAHQAaQB2AGUAIAB0AG8AIAB3AHIAYQBwAHAAZQByACAAZQB4AGUAYwB1AHQAYQBiAGwAZQAuAA0ACgAjAGkAbgBjAGwAdQBkAGUAIAAlAE0AVQBMAEUAXwBCAEEAUwBFACUALwBjAG8AbgBmAC8AdwByAGEAcABwAGUAcgAtAGEAZABkAGkAdABpAG8AbgBhAGwALgBjAG8AbgBmAA0ACgAjAGkAbgBjAGwAdQBkAGUAIAAlAE0AVQBMAEUAXwBCAEEAUwBFACUALwBjAG8AbgBmAC8AdwByAGEAcABwAGUAcgAtAGwAaQBjAGUAbgBzAGUALgBjAG8AbgBmAA0ACgA='
$content = [System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($EncodedText))
echo $content > "$muleInstallDir\conf\wrapper.conf"  

# Base64 encoded files to provide atomic provisioning
$EncodedText = 'LS0tDQp0cmFuc3BvcnRzOg0KICB3ZWJzb2NrZXQudHJhbnNwb3J0Og0KICAgIGVuYWJsZWQ6IGZhbHNlDQoNCiAgcmVzdC5hZ2VudC50cmFuc3BvcnQ6DQogICAgcG9ydDogOTk5OQ0KDQpzZXJ2aWNlczoNCiAgbXVsZS5hZ2VudC5qbXgucHVibGlzaGVyLnNlcnZpY2U6DQogICAgZW5hYmxlZDogdHJ1ZQ0KICAgIGZyZXF1ZW5jeTogMTUNCiAgICBmcmVxdWVuY3lUaW1lVW5pdDogTUlOVVRFUw0KICBtdWxlLmFnZW50LnRyYWNraW5nLnNlcnZpY2U6DQogICAgZ2xvYmFsVHJhY2tpbmdMZXZlbDogVFJBQ0tJTkc='
$ByteArray = [System.Convert]::FromBase64String($EncodedText)
[System.IO.File]::WriteAllBytes("$muleInstallDir\conf\mule-agent.yml", $ByteArray)

Write-Host "`n[$scriptName] List the Agent configuration file"
cat $muleInstallDir\conf\mule-agent.yml

$EncodedText = 'PAA/AHgAbQBsACAAdgBlAHIAcwBpAG8AbgA9ACIAMQAuADAAIgAgAGUAbgBjAG8AZABpAG4AZwA9ACIAVQBUAEYALQAxADYAIgA/AD4ADQAKADwAVABhAHMAawAgAHYAZQByAHMAaQBvAG4APQAiADEALgA0ACIAIAB4AG0AbABuAHMAPQAiAGgAdAB0AHAAOgAvAC8AcwBjAGgAZQBtAGEAcwAuAG0AaQBjAHIAbwBzAG8AZgB0AC4AYwBvAG0ALwB3AGkAbgBkAG8AdwBzAC8AMgAwADAANAAvADAAMgAvAG0AaQB0AC8AdABhAHMAawAiAD4ADQAKACAAIAA8AFIAZQBnAGkAcwB0AHIAYQB0AGkAbwBuAEkAbgBmAG8APgANAAoAIAAgACAAIAA8AEQAYQB0AGUAPgAyADAAMQA2AC0AMAAxAC0AMQA5AFQAMQA1ADoANQAyADoAMgA3AC4ANwA1ADUAOAA0ADgANwA8AC8ARABhAHQAZQA+AA0ACgAgACAAIAAgADwAQQB1AHQAaABvAHIAPgBEAGEAdABhAGMAbwBtACAATgBaACAATAB0AGQALgA8AC8AQQB1AHQAaABvAHIAPgANAAoAIAAgACAAIAA8AEQAZQBzAGMAcgBpAHAAdABpAG8AbgA+AFMAZQB0ACAAdABoAGUAIABhAGYAZgBpAG4AaQB0AHkAIAB0AG8AIAAxAEMAUABVACAAdABvACAAdABoAGUAIABNAHUAbABlACAARQBFACAAcAByAG8AYwBlAHMAcwAuADwALwBEAGUAcwBjAHIAaQBwAHQAaQBvAG4APgANAAoAIAAgADwALwBSAGUAZwBpAHMAdAByAGEAdABpAG8AbgBJAG4AZgBvAD4ADQAKACAAIAA8AFQAcgBpAGcAZwBlAHIAcwA+AA0ACgAgACAAIAAgADwARQB2AGUAbgB0AFQAcgBpAGcAZwBlAHIAPgANAAoAIAAgACAAIAAgACAAPABFAG4AYQBiAGwAZQBkAD4AdAByAHUAZQA8AC8ARQBuAGEAYgBsAGUAZAA+AA0ACgAgACAAIAAgACAAIAA8AFMAdQBiAHMAYwByAGkAcAB0AGkAbwBuAD4AJgBsAHQAOwBRAHUAZQByAHkATABpAHMAdAAmAGcAdAA7ACYAbAB0ADsAUQB1AGUAcgB5ACAASQBkAD0AIgAwACIAIABQAGEAdABoAD0AIgBTAHkAcwB0AGUAbQAiACYAZwB0ADsAJgBsAHQAOwBTAGUAbABlAGMAdAAgAFAAYQB0AGgAPQAiAFMAeQBzAHQAZQBtACIAJgBnAHQAOwANAAoAIAAgACAAIAAgACAAIAAqAFsAUwB5AHMAdABlAG0AWwBQAHIAbwB2AGkAZABlAHIAWwBAAE4AYQBtAGUAPQAnAFMAZQByAHYAaQBjAGUAIABDAG8AbgB0AHIAbwBsACAATQBhAG4AYQBnAGUAcgAnAF0AIABhAG4AZAAgACgARQB2AGUAbgB0AEkARAA9ADcAMAAzADYAKQBdAF0ADQAKACAAIAAgACAAIAAgACAAYQBuAGQAIAANAAoAIAAgACAAIAAgACAAIAAgACoAWwBFAHYAZQBuAHQARABhAHQAYQBbAEQAYQB0AGEAWwBAAE4AYQBtAGUAPQAnAHAAYQByAGEAbQAxACcAXQAgAGEAbgBkACAAKABEAGEAdABhAD0AJwBNAHUAbABlACAARQBuAHQAZQByAHAAcgBpAHMAZQAgAEUAZABpAHQAaQBvAG4AJwApAF0AXQAgAA0ACgAgACAAIAAgACAAIAAgAGEAbgBkACAADQAKACAAIAAgACAAIAAgACAAIAAqAFsARQB2AGUAbgB0AEQAYQB0AGEAWwBEAGEAdABhAFsAQABOAGEAbQBlAD0AJwBwAGEAcgBhAG0AMgAnAF0AIABhAG4AZAAgACgARABhAHQAYQA9ACcAcgB1AG4AbgBpAG4AZwAnACkAXQBdACAADQAKACAAIAAgACAAJgBsAHQAOwAvAFMAZQBsAGUAYwB0ACYAZwB0ADsAJgBsAHQAOwAvAFEAdQBlAHIAeQAmAGcAdAA7ACYAbAB0ADsALwBRAHUAZQByAHkATABpAHMAdAAmAGcAdAA7ADwALwBTAHUAYgBzAGMAcgBpAHAAdABpAG8AbgA+AA0ACgAgACAAIAAgADwALwBFAHYAZQBuAHQAVAByAGkAZwBnAGUAcgA+AA0ACgAgACAAPAAvAFQAcgBpAGcAZwBlAHIAcwA+AA0ACgAgACAAPABQAHIAaQBuAGMAaQBwAGEAbABzAD4ADQAKACAAIAAgACAAPABQAHIAaQBuAGMAaQBwAGEAbAAgAGkAZAA9ACIAQQB1AHQAaABvAHIAIgA+AA0ACgAgACAAIAAgACAAIAA8AFIAdQBuAEwAZQB2AGUAbAA+AEgAaQBnAGgAZQBzAHQAQQB2AGEAaQBsAGEAYgBsAGUAPAAvAFIAdQBuAEwAZQB2AGUAbAA+AA0ACgAgACAAIAAgACAAIAA8AEwAbwBnAG8AbgBUAHkAcABlAD4AUwA0AFUAPAAvAEwAbwBnAG8AbgBUAHkAcABlAD4ADQAKACAAIAAgACAAPAAvAFAAcgBpAG4AYwBpAHAAYQBsAD4ADQAKACAAIAA8AC8AUAByAGkAbgBjAGkAcABhAGwAcwA+AA0ACgAgACAAPABTAGUAdAB0AGkAbgBnAHMAPgANAAoAIAAgACAAIAA8AE0AdQBsAHQAaQBwAGwAZQBJAG4AcwB0AGEAbgBjAGUAcwBQAG8AbABpAGMAeQA+AEkAZwBuAG8AcgBlAE4AZQB3ADwALwBNAHUAbAB0AGkAcABsAGUASQBuAHMAdABhAG4AYwBlAHMAUABvAGwAaQBjAHkAPgANAAoAIAAgACAAIAA8AEQAaQBzAGEAbABsAG8AdwBTAHQAYQByAHQASQBmAE8AbgBCAGEAdAB0AGUAcgBpAGUAcwA+AGYAYQBsAHMAZQA8AC8ARABpAHMAYQBsAGwAbwB3AFMAdABhAHIAdABJAGYATwBuAEIAYQB0AHQAZQByAGkAZQBzAD4ADQAKACAAIAAgACAAPABTAHQAbwBwAEkAZgBHAG8AaQBuAGcATwBuAEIAYQB0AHQAZQByAGkAZQBzAD4AZgBhAGwAcwBlADwALwBTAHQAbwBwAEkAZgBHAG8AaQBuAGcATwBuAEIAYQB0AHQAZQByAGkAZQBzAD4ADQAKACAAIAAgACAAPABBAGwAbABvAHcASABhAHIAZABUAGUAcgBtAGkAbgBhAHQAZQA+AHQAcgB1AGUAPAAvAEEAbABsAG8AdwBIAGEAcgBkAFQAZQByAG0AaQBuAGEAdABlAD4ADQAKACAAIAAgACAAPABTAHQAYQByAHQAVwBoAGUAbgBBAHYAYQBpAGwAYQBiAGwAZQA+AGYAYQBsAHMAZQA8AC8AUwB0AGEAcgB0AFcAaABlAG4AQQB2AGEAaQBsAGEAYgBsAGUAPgANAAoAIAAgACAAIAA8AFIAdQBuAE8AbgBsAHkASQBmAE4AZQB0AHcAbwByAGsAQQB2AGEAaQBsAGEAYgBsAGUAPgBmAGEAbABzAGUAPAAvAFIAdQBuAE8AbgBsAHkASQBmAE4AZQB0AHcAbwByAGsAQQB2AGEAaQBsAGEAYgBsAGUAPgANAAoAIAAgACAAIAA8AEkAZABsAGUAUwBlAHQAdABpAG4AZwBzAD4ADQAKACAAIAAgACAAIAAgADwAUwB0AG8AcABPAG4ASQBkAGwAZQBFAG4AZAA+AHQAcgB1AGUAPAAvAFMAdABvAHAATwBuAEkAZABsAGUARQBuAGQAPgANAAoAIAAgACAAIAAgACAAPABSAGUAcwB0AGEAcgB0AE8AbgBJAGQAbABlAD4AZgBhAGwAcwBlADwALwBSAGUAcwB0AGEAcgB0AE8AbgBJAGQAbABlAD4ADQAKACAAIAAgACAAPAAvAEkAZABsAGUAUwBlAHQAdABpAG4AZwBzAD4ADQAKACAAIAAgACAAPABBAGwAbABvAHcAUwB0AGEAcgB0AE8AbgBEAGUAbQBhAG4AZAA+AHQAcgB1AGUAPAAvAEEAbABsAG8AdwBTAHQAYQByAHQATwBuAEQAZQBtAGEAbgBkAD4ADQAKACAAIAAgACAAPABFAG4AYQBiAGwAZQBkAD4AdAByAHUAZQA8AC8ARQBuAGEAYgBsAGUAZAA+AA0ACgAgACAAIAAgADwASABpAGQAZABlAG4APgB0AHIAdQBlADwALwBIAGkAZABkAGUAbgA+AA0ACgAgACAAIAAgADwAUgB1AG4ATwBuAGwAeQBJAGYASQBkAGwAZQA+AGYAYQBsAHMAZQA8AC8AUgB1AG4ATwBuAGwAeQBJAGYASQBkAGwAZQA+AA0ACgAgACAAIAAgADwARABpAHMAYQBsAGwAbwB3AFMAdABhAHIAdABPAG4AUgBlAG0AbwB0AGUAQQBwAHAAUwBlAHMAcwBpAG8AbgA+AGYAYQBsAHMAZQA8AC8ARABpAHMAYQBsAGwAbwB3AFMAdABhAHIAdABPAG4AUgBlAG0AbwB0AGUAQQBwAHAAUwBlAHMAcwBpAG8AbgA+AA0ACgAgACAAIAAgADwAVQBzAGUAVQBuAGkAZgBpAGUAZABTAGMAaABlAGQAdQBsAGkAbgBnAEUAbgBnAGkAbgBlAD4AZgBhAGwAcwBlADwALwBVAHMAZQBVAG4AaQBmAGkAZQBkAFMAYwBoAGUAZAB1AGwAaQBuAGcARQBuAGcAaQBuAGUAPgANAAoAIAAgACAAIAA8AFcAYQBrAGUAVABvAFIAdQBuAD4AZgBhAGwAcwBlADwALwBXAGEAawBlAFQAbwBSAHUAbgA+AA0ACgAgACAAIAAgADwARQB4AGUAYwB1AHQAaQBvAG4AVABpAG0AZQBMAGkAbQBpAHQAPgBQADMARAA8AC8ARQB4AGUAYwB1AHQAaQBvAG4AVABpAG0AZQBMAGkAbQBpAHQAPgANAAoAIAAgACAAIAA8AFAAcgBpAG8AcgBpAHQAeQA+ADcAPAAvAFAAcgBpAG8AcgBpAHQAeQA+AA0ACgAgACAAPAAvAFMAZQB0AHQAaQBuAGcAcwA+AA0ACgAgACAAPABBAGMAdABpAG8AbgBzACAAQwBvAG4AdABlAHgAdAA9ACIAQQB1AHQAaABvAHIAIgA+AA0ACgAgACAAIAAgADwARQB4AGUAYwA+AA0ACgAgACAAIAAgACAAIAA8AEMAbwBtAG0AYQBuAGQAPgBwAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUAPAAvAEMAbwBtAG0AYQBuAGQAPgANAAoAIAAgACAAIAAgACAAPABBAHIAZwB1AG0AZQBuAHQAcwA+AEAATQBVAEwARQBfAFQAQQBTAEsAXwBTAEMAUgBJAFAAVABfAEgATwBNAEUAQABcAFMAZQB0AC0AQQBmAGYAaQBuAGkAdAB5AC0ATQB1AGwAZQBFAEUALQBUAGEAcwBrAC4AcABzADEAPAAvAEEAcgBnAHUAbQBlAG4AdABzAD4ADQAKACAAIAAgACAAPAAvAEUAeABlAGMAPgANAAoAIAAgADwALwBBAGMAdABpAG8AbgBzAD4ADQAKADwALwBUAGEAcwBrAD4ADQAKAA=='
$content = [System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($EncodedText))
echo $content > "$muleInstallDir\conf\Set-Affinity-MuleEE-Task-Definition.xml"  

$EncodedText = 'IABmAHUAbgBjAHQAaQBvAG4AIABGAGkAbgBkAC0AQwBoAGkAbABkAFAAcgBvAGMAZQBzAHMAIAB7ACAADQAKACAAIABwAGEAcgBhAG0AKAAkAEkARAA9ACQAUABJAEQAKQAgAA0ACgAgAA0ACgAgACAAIAAgACQAQwB1AHMAdABvAG0AQwBvAGwAdQBtAG4ASQBEACAAPQAgAEAAewAgAA0ACgAgACAAIAAgACAAIAAgACAATgBhAG0AZQAgAD0AIAAnAEkAZAAnACAADQAKACAAIAAgACAAIAAgACAAIABFAHgAcAByAGUAcwBzAGkAbwBuACAAPQAgAHsAIABbAEkAbgB0AFsAXQBdACQAXwAuAFAAcgBvAGMAZQBzAHMASQBEACAAfQAgAA0ACgAgACAAIAAgAH0AIAANAAoAIAANAAoAIAAgACAAIAAkAHIAZQBzAHUAbAB0ACAAPQAgAEcAZQB0AC0AVwBtAGkATwBiAGoAZQBjAHQAIAAtAEMAbABhAHMAcwAgAFcAaQBuADMAMgBfAFAAcgBvAGMAZQBzAHMAIAAtAEYAaQBsAHQAZQByACAAIgBQAGEAcgBlAG4AdABQAHIAbwBjAGUAcwBzAEkARAA9ACQASQBEACIAIAB8ACAADQAKACAAIAAgACAAIAAgAFMAZQBsAGUAYwB0AC0ATwBiAGoAZQBjAHQAIAAtAFAAcgBvAHAAZQByAHQAeQAgAFAAcgBvAGMAZQBzAHMATgBhAG0AZQAsACAAJABDAHUAcwB0AG8AbQBDAG8AbAB1AG0AbgBJAEQALAAgAEMAbwBtAG0AYQBuAGQATABpAG4AZQANAAoADQAKACAAIAAgACAAJAByAGUAcwB1AGwAdAAgAHwAIAAgAA0ACgAgACAAIAAgACAAIAAgACAAVwBoAGUAcgBlAC0ATwBiAGoAZQBjAHQAIAB7ACAAJABfAC4ASQBEACAALQBuAGUAIAAkAG4AdQBsAGwAIAB9ACAAfAAgACAADQAKACAAIAAgACAAIAAgACAAIABGAG8AcgBFAGEAYwBoAC0ATwBiAGoAZQBjAHQAIAB7ACAADQAKACAAIAAgACAAIAAgACAAIABGAGkAbgBkAC0AQwBoAGkAbABkAFAAcgBvAGMAZQBzAHMAIAAtAGkAZAAgACQAXwAuAEkAZAAgAA0ACgAgACAAIAAgAH0AIAANAAoADQAKACAAIAAgACAAcgBlAHQAdQByAG4AIAAkAHIAZQBzAHUAbAB0ADsADQAKAH0ADQAKAA0ACgBmAHUAbgBjAHQAaQBvAG4AIABTAGUAdAAtAFAAcgBvAGMAZQBzAHMAbwByAEEAZgBmAGkAbgBpAHQAeQAgAHsADQAKAAkAcABhAHIAYQBtACgADQAKAAkACQBbAFAAYQByAGEAbQBlAHQAZQByACgATQBhAG4AZABhAHQAbwByAHkAPQAkAHQAcgB1AGUAKQBdAA0ACgAJAAkAWwBJAG4AdABdACQASQBEAA0ACgAJACkADQAKAA0ACgAgACAAIAAgACQAcAByAG8AYwBlAHMAcwAgAD0AIABnAGUAdAAtAHAAcgBvAGMAZQBzAHMAIAAtAFAASQBEACAAJABJAEQAOwANAAoAIAAgACAAIAAkAHAAcgBvAGMAZQBzAHMALgBQAHIAbwBjAGUAcwBzAG8AcgBBAGYAZgBpAG4AaQB0AHkAPQAxADsADQAKAH0ADQAKAA0ACgAgACQAcwBlAHIAdgBpAGMAZQA9AGcAZQB0AC0AdwBtAGkAbwBiAGoAZQBjAHQAIAB3AGkAbgAzADIAXwBzAGUAcgB2AGkAYwBlACAAfAAgAHcAaABlAHIAZQAtAG8AYgBqAGUAYwB0ACAAewAkAF8ALgBOAGEAbQBlACAALQBpAGUAcQAgACIAbQB1AGwAZQBfAGUAZQAiAH0AOwANAAoAIAANAAoAIABpAGYAIAAoACQAcwBlAHIAdgBpAGMAZQApACAAewANAAoAIAAgACAAIABpAGYAIAAoACQAcwBlAHIAdgBpAGMAZQAuAFMAdABhAHQAZQAgAC0AaQBlAHEAIAAnAFIAdQBuAG4AaQBuAGcAJwApACAAewANAAoAIAAgACAAIAAgACAAIAAgAFMAZQB0AC0ARQB4AGUAYwB1AHQAaQBvAG4AUABvAGwAaQBjAHkAIABVAG4AcgBlAHMAdAByAGkAYwB0AGUAZAAgAC0AUwBjAG8AcABlACAAUAByAG8AYwBlAHMAcwAgAC0AZgBvAHIAYwBlAA0ACgANAAoAIAAgACAAIAAgACAAIAAgACMAIABzAGUAdAAgAHQAaABlACAAYQBmAGYAaQBuAGkAdAB5ACAAZgBvAHIAIAB0AGgAZQAgAHcAcgBhAHAAcABlAHIAIABtAHUAbABlACAAcAByAG8AYwBlAHMAcwANAAoAIAAgACAAIAAgACAAIAAgAFMAZQB0AC0AUAByAG8AYwBlAHMAcwBvAHIAQQBmAGYAaQBuAGkAdAB5ACAALQBJAEQAIAAkAHMAZQByAHYAaQBjAGUALgBQAHIAbwBjAGUAcwBzAEkAZAA7AA0ACgANAAoAIAAgACAAIAAgACAAIAAgACMAIABzAGUAdAAgAHQAaABlACAAYQBmAGYAaQBuAGkAdAB5ACAAZgBvAHIAIABhAGwAbAAgAGkAdABzACAAcwB1AGIALQBwAHIAbwBjAGUAcwBzAGUAcwANAAoAIAAgACAAIAAgACAAIAAgAEYAaQBuAGQALQBDAGgAaQBsAGQAUAByAG8AYwBlAHMAcwAgAC0ASQBEACAAJABzAGUAcgB2AGkAYwBlAC4AUAByAG8AYwBlAHMAcwBJAGQAIAB8ACAAZgBvAHIAZQBhAGMAaAAtAG8AYgBqAGUAYwB0ACAAewAgAFMAZQB0AC0AUAByAG8AYwBlAHMAcwBvAHIAQQBmAGYAaQBuAGkAdAB5ACAALQBJAEQAIAAkAF8ALgBJAGQAOwAgAH0ADQAKAA0ACgAgACAAIAAgAAkAJABzAHQAcgBMAGkAbgBlAD0AJwBVAHAAZABhAHQAZQBkACAAcwBlAHIAdgBpAGMAZQAgACIAJwAgACsAIAAkAHMAZQByAHYAaQBjAGUALgBuAGEAbQBlACAAKwAgACcAIgA6ACAAYQBmAGYAaQBuAGkAdAB5ACAAdQBwAGQAYQB0AGUAZAAgAHQAbwAgAD0AJwAgACsAIAAkAHAAcgBvAGMAZQBzAHMALgBQAHIAbwBjAGUAcwBzAG8AcgBBAGYAZgBpAG4AaQB0AHkAIAArACAAJwBDAFAAVQAoAHMAKQAnADsADQAKACAAIAAgAAkACQB3AHIAaQB0AGUALQBlAHYAZQBuAHQAbABvAGcAIAAtAGwAbwBnAG4AYQBtAGUAIABTAHkAcwB0AGUAbQAgAC0AcwBvAHUAcgBjAGUAIAAnAE0AdQBsAGUAIABFAG4AdABlAHIAcAByAGkAcwBlACAARQBkAGkAdABpAG8AbgAnACAALQBlAHYAZQBuAHQASQBEACAAOAAwADMANgAgAC0AbQBlAHMAcwBhAGcAZQAgACQAcwB0AHIATABpAG4AZQAJACAAIAAgACAAIAAgACAAIAAgACAAIAAgAA0ACgAgACAAIAAgAH0ADQAKACAAfQANAAoA'
$content = [System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($EncodedText))
echo $content > "$muleInstallDir\conf\Set-Affinity-MuleEE-Task.ps1"  

if ($InstallLicense -eq "yes") {
	# Copy the license (this is the digested license). With the digested license, we can skip to run the install license script
	# the script doen not work properly from a remote power shell connection anyway
	executeExpression "Copy-Item `'$sourceInstallDir\configs\muleLicenseKey.lic`' `'$muleInstallDir\conf\muleLicenseKey.lic`'"

	# Copy the task definition and script that check if the license has been succesfully installed and if it is valid
	executeExpression "Copy-Item `'$sourceInstallDir\configs\Verify-License-MuleEE-Task-Definition.xml`' `'$muleInstallDir\conf\Verify-License-MuleEE-Task-Definition.xml`'" 
	executeExpression "Copy-Item `'$sourceInstallDir\configs\Verify-License-MuleEE-Task.ps1`' `'$muleInstallDir\conf\Verify-License-MuleEE-Task.ps1`'"
}

$value='replacewithkey'
$file ="$muleInstallDir\conf\wrapper.conf"
Write-Host "`n[$scriptName] Replace @MULE_KEY@ with `$value in $file"
(Get-Content $file | ForEach-Object { $_ -replace "@MULE_KEY@", "$value" } ) | Set-Content $file
(Get-Content $file | ForEach-Object { $_ -replace "%MULE_ENV%", 'Dev' } ) | Set-Content $file

Write-Host "`n[$scriptName] Mule EE Standalone installation ..."
Write-Host "[$scriptName] Setting affinity to single process ...`n"
try {
	$winDir=$(Get-ChildItem -Path Env:\WinDir).Value;
	Copy-Item "$muleInstallDir\conf\Set-Affinity-MuleEE-Task.ps1" $winDir -Recurse -Force | Out-Null
	$taskDefFile="$muleInstallDir\conf\Set-Affinity-MuleEE-Task-Definition.xml"
	(Get-Content $taskDefFile | ForEach-Object { $_ -replace "@MULE_TASK_SCRIPT_HOME@", $winDir } ) | Set-Content $taskDefFile	
	
	#create the scheduller task that sets the Mule affinity to 1 CPU
	New-EventLog -LogName System -Source 'Mule Enterprise Edition' | Out-Null	
	Start-Process schtasks -ArgumentList "/create /TN Set-Affinity-MuleEE-Task /XML `"$taskDefFile`"" -NoNewWindow -Wait
} catch {
	Write-Host "Setting Mule affinity failed!" -ForegroundColor Red
	throw $_
}	
Write-Host "[$scriptName] Setting affinity complete."

Write-Host "`n[$scriptName] Start and verify >"
Write-Host "`n[$scriptName] InstallMule EE as a windows service >>"
try {
	Start-Process "$muleInstallDir\bin\mule" -ArgumentList "install" -Wait
} catch {
	Write-Host "Unexpected Error. Error details: $_.Exception.Message" -ForegroundColor Red
	throw $_
}	
Write-Host "[$scriptName] Start Mule windows service`n"
$service = executeExpression "Start-Service '$muleServiceName' -WarningAction SilentlyContinue -PassThru"

# Install the task scheduller that verifies the EE license 
Write-Host "[$scriptName] Install license ($InstallLicense)"
if ($InstallLicense -eq "yes") {
	Write-Host "`n[$scriptName] Install Mule License Verifier scheduller ...`n"
	try {
		$winDir = $(Get-ChildItem -Path Env:\WinDir).Value
		Copy-Item "$muleInstallDir\conf\Verify-License-MuleEE-Task.ps1" $winDir -Recurse -Force | Out-Null
		$taskDefFile = "$muleInstallDir\conf\Verify-License-MuleEE-Task-Definition.xml"
		(Get-Content $taskDefFile | ForEach-Object { $_ -replace "@MULE_TASK_SCRIPT_HOME@", $winDir } ) | Set-Content $taskDefFile	
		
		#create the scheduller task that right after creation will check the license status
		#the check of the license uses the provided Mule's batch command: "mule.bat -verifyLicense"
		if (-not [System.Diagnostics.EventLog]::SourceExists("Mule Enterprise Edition")) {
			New-EventLog -LogName System -Source 'Mule Enterprise Edition' | Out-Null	
		}
		Start-Process schtasks -ArgumentList "/create /TN Verify-License-MuleEE-Task /XML `"$taskDefFile`"" -NoNewWindow -Wait
	} catch {
		Write-Host "[$scriptName] Installing Mule License Verifier scheduller failed !" -ForegroundColor Red
		throw $_
	}	
	Write-Host "[$scriptName] Install Mule License Verifier scheduller complete.`n"
}        
       
if ( $MMC_GROUP ) {

	Write-Host "`n[$scriptName] Load the MMC software"
	executeExpression "Copy-Item `'$sourceInstallDir\$mmcWar`' `'$tomcatHomeDir\webapps\mmc.war`'"
	
	Write-Host
	$file = "$tomcatHomeDir\bin\autorun.groovy"
	$EncodedText = 'cHJpbnRsbigiTU1DIFVwZGF0ZVBhc3N3b3JkIHNjcmlwdCAtPiBTdGFydCAuLi4gIik7DQoNCnRyeSB7DQoJZGVmIGFjbSA9IGFwcGxpY2F0aW9uQ29udGV4dC5nZXRCZWFuKCJhY2Nlc3NDb250cm9sTWFuYWdlciIpOw0KCWRlZiB1bSA9IGFwcGxpY2F0aW9uQ29udGV4dC5nZXRCZWFuKCJ1c2VyTWFuYWdlciIpOw0KDQoJdW0uc2V0UGFzc3dvcmQoImFkbWluIiwgImFkbWluIiwgIkBNTUNfUEFTU1dPUkRAIik7DQoJcHJpbnRsbigiTU1DIFVwZGF0ZVBhc3N3b3JkIHNjcmlwdCAtPiBBZG1pbiBQYXNzd29yZCB1cGRhdGVkIHN1Y2Nlc3NmdWxseSIpOw0KfSBjYXRjaChFeGNlcHRpb24gZSkgew0KCXByaW50bG4oIk1NQyBVcGRhdGVQYXNzd29yZCBzY3JpcHQgLT4gR290IGV4Y2VwdGlvbjogIiArIGU/LmNhdXNlPy5jYXVzZSk7DQoJcHJpbnRsbigiTU1DIFVwZGF0ZVBhc3N3b3JkIHNjcmlwdCAtPiBGQUlMVVJFISIpOw0KCXJldHVybiAxOw0KfQ0KDQpwcmludGxuKCJNTUMgVXBkYXRlUGFzc3dvcmQgc2NyaXB0IC0+IFNVQ0NFU1MhIik7DQpyZXR1cm4gMDs='
	$ByteArray = [System.Convert]::FromBase64String($EncodedText)
	[System.IO.File]::WriteAllBytes("$file", $ByteArray)

	(Get-Content $file | ForEach-Object { $_ -replace "@MMC_PASSWORD@", "$mmcPassword" } ) | Set-Content $file

	$file = "$tomcatHomeDir\conf\tomcat-users.xml"
	$EncodedText = 'PD94bWwgdmVyc2lvbj0nMS4wJyBlbmNvZGluZz0nY3AxMjUyJz8+DQo8IS0tDQogIExpY2Vuc2VkIHRvIHRoZSBBcGFjaGUgU29mdHdhcmUgRm91bmRhdGlvbiAoQVNGKSB1bmRlciBvbmUgb3IgbW9yZQ0KICBjb250cmlidXRvciBsaWNlbnNlIGFncmVlbWVudHMuICBTZWUgdGhlIE5PVElDRSBmaWxlIGRpc3RyaWJ1dGVkIHdpdGgNCiAgdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIHJlZ2FyZGluZyBjb3B5cmlnaHQgb3duZXJzaGlwLg0KICBUaGUgQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byBZb3UgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMA0KICAodGhlICJMaWNlbnNlIik7IHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aA0KICB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdA0KDQogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjANCg0KICBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlDQogIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsDQogIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLg0KICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kDQogIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLg0KLS0+DQo8dG9tY2F0LXVzZXJzIHhtbG5zPSJodHRwOi8vdG9tY2F0LmFwYWNoZS5vcmcveG1sIg0KICAgICAgICAgICAgICB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIg0KICAgICAgICAgICAgICB4c2k6c2NoZW1hTG9jYXRpb249Imh0dHA6Ly90b21jYXQuYXBhY2hlLm9yZy94bWwgdG9tY2F0LXVzZXJzLnhzZCINCiAgICAgICAgICAgICAgdmVyc2lvbj0iMS4wIj4NCjx1c2VyIHVzZXJuYW1lPSJhZG1pbiIgcGFzc3dvcmQ9IkBNTUNfUEFTU1dPUkRAIiByb2xlcz0ibWFuYWdlci1ndWkiIC8+DQo8IS0tDQogIE5PVEU6ICBCeSBkZWZhdWx0LCBubyB1c2VyIGlzIGluY2x1ZGVkIGluIHRoZSAibWFuYWdlci1ndWkiIHJvbGUgcmVxdWlyZWQNCiAgdG8gb3BlcmF0ZSB0aGUgIi9tYW5hZ2VyL2h0bWwiIHdlYiBhcHBsaWNhdGlvbi4gIElmIHlvdSB3aXNoIHRvIHVzZSB0aGlzIGFwcCwNCiAgeW91IG11c3QgZGVmaW5lIHN1Y2ggYSB1c2VyIC0gdGhlIHVzZXJuYW1lIGFuZCBwYXNzd29yZCBhcmUgYXJiaXRyYXJ5Lg0KLS0+DQo8IS0tDQogIE5PVEU6ICBUaGUgc2FtcGxlIHVzZXIgYW5kIHJvbGUgZW50cmllcyBiZWxvdyBhcmUgd3JhcHBlZCBpbiBhIGNvbW1lbnQNCiAgYW5kIHRodXMgYXJlIGlnbm9yZWQgd2hlbiByZWFkaW5nIHRoaXMgZmlsZS4gRG8gbm90IGZvcmdldCB0byByZW1vdmUNCiAgPCEuLiAuLj4gdGhhdCBzdXJyb3VuZHMgdGhlbS4NCi0tPg0KPCEtLQ0KICA8cm9sZSByb2xlbmFtZT0idG9tY2F0Ii8+DQogIDxyb2xlIHJvbGVuYW1lPSJyb2xlMSIvPg0KICA8dXNlciB1c2VybmFtZT0idG9tY2F0IiBwYXNzd29yZD0idG9tY2F0IiByb2xlcz0idG9tY2F0Ii8+DQogIDx1c2VyIHVzZXJuYW1lPSJib3RoIiBwYXNzd29yZD0idG9tY2F0IiByb2xlcz0idG9tY2F0LHJvbGUxIi8+DQogIDx1c2VyIHVzZXJuYW1lPSJyb2xlMSIgcGFzc3dvcmQ9InRvbWNhdCIgcm9sZXM9InJvbGUxIi8+DQotLT4NCjwvdG9tY2F0LXVzZXJzPg0K'
	$ByteArray = [System.Convert]::FromBase64String($EncodedText)
	[System.IO.File]::WriteAllBytes("$file", $ByteArray)

	(Get-Content $file | ForEach-Object { $_ -replace "@MMC_PASSWORD@", "$mmcPassword" } ) | Set-Content $file
	
	$EncodedText = 'c2V0IEpBVkFfT1BUUz0tWG14MTAyNG0='
	$ByteArray = [System.Convert]::FromBase64String($EncodedText)
	[System.IO.File]::WriteAllBytes("$tomcatHomeDir\bin\setEnv.bat", $ByteArray)

	function List-ServerGroups {
		param (	
		    [Parameter(Mandatory=$false)]
			[String]$url='http://localhost:8080/mmc'
		)	
	
	    $result = [PSCustomObject]@{
	                total = 0
	                data = @()
	            };
				
		try {
			$result = Invoke-RestMethod -Uri "$url/api/serverGroups" -Headers $Headers;				
		} catch {		
			Write-Host "ERROR" $_ -ForegroundColor red
			Return $result;
		}	
		
		return $result;
	}
	
	function muleRegisterServer {
		param (	
		    [Parameter(Mandatory=$false)]
			[String]$url='http://localhost:8080/mmc',
			
		    [Parameter(Mandatory=$true)]
			[String]$name,
	
		    [Parameter(Mandatory=$false)]
			[String]$agentUrl='http://localhost:7777/mmc-support',
	
		    [Parameter(Mandatory=$true)]
			[String]$groupId
		)	
	
		$request= @{
		    name = $name.ToUpper();
		    agentUrl = $agentUrl;
		    groupIds = @($groupId)
		};
		$jsonRequest = ConvertTo-Json -InputObject $request;
		
		$result=$null;
	
		try {
			## Write-Host "[DEBUG][muleRegisterServer] `$result = Invoke-RestMethod -Uri `"$url/api/servers`" -Body $jsonRequest -Headers `$Headers -ContentType `"application/json`" -Method POST;" -ForegroundColor Blue
			$result = Invoke-RestMethod -Uri "$url/api/servers" -Body $jsonRequest -Headers $Headers -ContentType "application/json" -Method POST;		
		} catch {		
			Write-Host "Registration failed, wait 30 seconds and then retry ..." $_ -ForegroundColor Yellow
			sleep 30
			try {
				## Write-Host "[DEBUG][muleRegisterServer] `$result = Invoke-RestMethod -Uri `"$url/api/servers`" -Body $jsonRequest -Headers `$Headers -ContentType `"application/json`" -Method POST;" -ForegroundColor Blue
				$result = Invoke-RestMethod -Uri "$url/api/servers" -Body $jsonRequest -Headers $Headers -ContentType "application/json" -Method POST;		
			} catch {		
				Write-Host "Registration failed" -ForegroundColor red
				throw $_ 
			}
		}	
		
		return $result	
	}
	
	Write-Host -NoNewline "`nVerify MMC is ready for requests : "
	$wait = 10
	$retryMax = 30 # very slow when provisioned on Azure
	$retryCount = 0
	$uri='http://localhost:8080/mmc'
	while ( $retryCount -lt $retryMax ) {
		try {
			$response = Invoke-WebRequest -Uri "$uri" -UseBasicParsing
	    } catch {
			Write-Host "Wait 10 seconds and retry"
			sleep $wait
	    }
	    if ( $response ) {
	    	$retryCount = $retryMax
		}
		$retryCount += 1
	}
	
	# Register the server
	# At this stage, the Mule server is recognized by MMC, but it is unregistered
	# so register the server
	$user = 'admin'
	$pass = 'admin'
	$pair = "$($user):$($pass)"
	$encodedCreds = [System.Convert]::ToBase64String([System.Text.Encoding]::ASCII.GetBytes($pair))
	$basicAuthValue = "Basic $encodedCreds"
	$Headers = @{Authorization = $basicAuthValue}
	$serverName=($env:computername).ToUpper();
	Write-Host "`n[$scriptName] Register server name $serverName in MMC for environment $MMC_GROUP >>`n"
	$foundGroup = $false;
	(List-ServerGroups).data | ForEach-Object {
		## Write-Host "[DEBUG] `$_ = $_" -ForegroundColor Blue
	    if ($_.name -ieq $MMC_GROUP) {
			try {
				Write-Host "[$scriptName] muleRegisterServer -name $serverName -groupId $_.id ($MMC_GROUP)"
	            muleRegisterServer -name $serverName -groupId $_.id;      
			} catch {
				Write-Host "[$scriptName] muleRegisterServer threw exception!" -ForegroundColor Red
				throw $_
			}	
	        $foundGroup=$true;
	    }
	}
	
	if(-not $foundGroup) {
	    throw "[$scriptName] Couldn't find a server group for the environment"
	}
	Write-Host "MMC Install and Configuration Complete"
}

Write-Host -NoNewline "`nVerify Agent has installed : "
$wait = 10
$retryMax = 3
$retryCount = 0
$uri='http://localhost:9999/mule/domains'
while ( $retryCount -lt $retryMax ) {

	try {
	
        ## Write-Host "[DEBUG] `$response = Invoke-WebRequest -Uri `"$uri`" -UseBasicParsing" -ForegroundColor Blue
		$response = Invoke-WebRequest -Uri "$uri" -UseBasicParsing
		
    } catch {
     
		Write-Host "Wait 10 seconds and retry"
		sleep $wait
    }
    
    ## Write-Host "[DEBUG] `$response = $response" -ForegroundColor Blue
    # if successful, set the retry to maximum to stop the loop
    if ( $response ) {
    	$retryCount = $retryMax
	}
	
	$retryCount += 1
}

Write-Host "n`[$scriptName] ---------- stop -----------`n"
$error.clear()
exit 0